const chatBtn = document.getElementById("chatbot-btn");
const chatWindow = document.getElementById("chatContainer");
const closeChat = document.getElementById("closeChat");

chatBtn.onclick = () => {
    chatWindow.style.display = "flex";

    //  Slide + fade animation
    setTimeout(() => {
        chatWindow.classList.add("show");
    }, 20);

    //  Bounce effect on floating button
    chatBtn.classList.add("clicked");
    setTimeout(() => chatBtn.classList.remove("clicked"), 400);
};

closeChat.onclick = () => {
    chatWindow.classList.remove("show");

    setTimeout(() => {
        chatWindow.style.display = "none";
    }, 350);
};

const sendBtn = document.getElementById("sendBtn");
const input = document.getElementById("userInput");
const chatBody = document.getElementById("chatBody");
const mainAvatar = document.getElementById("mainBotAvatar");

sendBtn.addEventListener("click", sendMessage);
input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
});

/* Suggestions */
document.querySelectorAll(".suggest-btn").forEach(btn => {
    btn.onclick = () => {
        input.value = btn.innerText;
        sendMessage();
    };
});

function sendMessage() {
    let message = input.value.trim();
    if (message === "") return;

    let userMsg = document.createElement("div");
    userMsg.className = "user-message";
    userMsg.innerHTML = `<p>${message}</p>`;
    chatBody.appendChild(userMsg);
    chatBody.scrollTop = chatBody.scrollHeight;

    input.value = "";

    let greetings = ["hi", "hello", "hii", "hey", "hola", "hi shri", "hello shri"];
    let cleaned = message.toLowerCase();

    let randomGreetings = [
        "Hello! ğŸ˜Š How else can I help you?",
        "Hi there! ğŸ‘‹ What would you like to know?",
        "Hey! ğŸ§‘â€ğŸ’» How can I assist you today?",
        "Hello! ğŸ˜ Feel free to ask anything.",
        "Hi! âœ… I'm here to help."
    ];
    //  College replies
const qa = [
    { q: ["admission", "how to take admission", "admission process"], 
      a: "ğŸ“Œ *Admission Process:*<br>â€¢ Visit the college office<br>â€¢ Fill admission form<br>â€¢ Submit required documents<br>â€¢ Pay fees at counter<br><br>For more details, contact the college office." 
    },

    { q: ["fees", "fee structure", "course fees"], 
      a: "ğŸ’° *Fee Structure:*<br>â€¢ BCA â€“ â‚¹30,000 / year<br>â€¢ BBA â€“ â‚¹28,000 / year<br>â€¢ BSc â€“ â‚¹25,000 / year<br> B.Tech - 40,000 to 70,000 / year<br><br>Note: Fees may vary; contact admin for confirmation." 
    },

    { q: ["timing", "college timing", "when college opens"], 
      a: "â° *College Timings:*<br>Monday to Friday â†’ 9:00 AM â€“ 4:00 PM" 
    },

    { q: ["holiday", "holidays", "vacation"], 
      a: "ğŸ“… *Holiday List:*<br>â€¢ Sunday â€“ Weekly Off<br>â€¢ National Holidays (26 Jan, 15 Aug, 2 Oct)<br>â€¢ Diwali Holidays: 5 Days" 
    },

    { q: ["facility", "facilities", "campus"], 
      a: "ğŸ« *Campus Facilities:*<br>â€¢ Library<br>â€¢ Computer Lab<br>â€¢ Smart Classrooms<br>â€¢ Sports Ground<br>â€¢ Canteen" 
    },

    { q: ["principal", "hod", "contact"], 
      a: "ğŸ“ *Important Contacts:*<br>â€¢ Principal: 1234567890<br>â€¢ Office: 9876543210" 
    }
];

let reply = "";

// If greeting â†’ random reply
if (greetings.includes(cleaned)) {
    reply = randomGreetings[Math.floor(Math.random() * randomGreetings.length)];
} else {
    // Search through custom college questions
    let found = false;

    for (let i = 0; i < qa.length; i++) {
        for (let keyword of qa[i].q) {
            if (cleaned.includes(keyword)) {
                reply = qa[i].a;
                found = true;
                break;
            }
        }
        if (found) break;
    }

    // If nothing matched â†’ default
    if (!found) {
        reply = `<strong>NOTE:</strong> Kindly ask only your college related queries ğŸ™`;
    }
}

    //  Typing animation
    mainAvatar.classList.add("typing-glow");

    let typing = document.createElement("div");
    typing.className = "typing";
    typing.innerHTML = `
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
`;
    chatBody.appendChild(typing);
    chatBody.scrollTop = chatBody.scrollHeight;

let delay = Math.floor(Math.random() * 1500) + 1000; // between 1â€“2.5 sec

setTimeout(() => {
        typing.remove();
        mainAvatar.classList.remove("typing-glow");

        let botMsg = document.createElement("div");
        botMsg.className = "bot-message";
        botMsg.innerHTML = `
            <div class="bot-avatar small">ğŸ¤–</div>
            <p>${reply}</p>
        `;
        chatBody.appendChild(botMsg);

        chatBody.scrollTop = chatBody.scrollHeight;

    }, 2500);
}

/*  Voice Input â€“ Speech to Text */
const voiceBtn = document.getElementById("voiceBtn");

let recognition;
if ("webkitSpeechRecognition" in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "en-IN";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = () => {
        voiceBtn.classList.add("listening");
        voiceBtn.innerText = "ğŸ™ï¸";
    };

    recognition.onend = () => {
        voiceBtn.classList.remove("listening");
        voiceBtn.innerText = "ğŸ¤";
    };

    recognition.onresult = (event) => {
        const speech = event.results[0][0].transcript;
        input.value = speech;
        sendMessage();
    };
}

voiceBtn.onclick = () => {
    if (recognition) recognition.start();
    else alert("Your browser does not support Speech Recognition");
};

//  Google Sheet notice fetch
const noticeUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRoQU9GJHi-PAcHqawJorVdh_XpX7kDGeH_tuMBeC8G9dGoms4nwUtQtkcy_GeGyHJDMgahpkvr94Cz/pub?gid=0&single=true&output=csv";

let lastNotice = ""; // to store last notice

async function fetchNotice() {
    try {
        const res = await fetch(noticeUrl);
        const text = await res.text();
        const rows = text.split("\n");
        const latest = rows[1]?.split(",")[0] || "No notice found";

        if (latest !== lastNotice) {
            lastNotice = latest;
            showNotice(latest);
        }

    } catch (err) {
        console.log("Notice fetch error:", err);
    }
}
function showNotice(msg) {
    let botMsg = document.createElement("div");
    botMsg.className = "bot-message";
    botMsg.innerHTML = `
        <div class="bot-avatar small">ğŸ¤–</div>
        <p><strong>ğŸ“¢ Notice:</strong> ${msg}</p>
    `;
    chatBody.appendChild(botMsg);
    chatBody.scrollTop = chatBody.scrollHeight;
}
document.getElementById("noticeBtn").onclick = () => {
    fetchNotice();
};
